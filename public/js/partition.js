var photos = new Backbone.Collection([
    {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:05Z",
      "fingerprint": "dbb7619deeb4f2cd99d535f633d7481c",
      "id": "51e8ed19b09ddc000200000a",
      "s3_object_key": "fe766076-f472-e5a5-f173-bded6975ce8a",
      "shot_at": "2013-03-30T12:04:57Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:05Z",
      "fingerprint": "a31bfeb21cb9339a8e7613e2cbae47b8",
      "id": "51e8ed19b09ddc000200000c",
      "s3_object_key": "ebe0117b-9351-c1e4-2e51-51c88f4132fb",
      "shot_at": "2013-03-30T11:01:10Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:06Z",
      "fingerprint": "e62d95406399d3b5a0a3fe209bb55b50",
      "id": "51e8ed1ae2129b0002000008",
      "s3_object_key": "0434dc64-0226-6250-30eb-42b282eefb40",
      "shot_at": "2013-03-30T09:46:33Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:07Z",
      "fingerprint": "1a868b6fa3a2bf5d429c6a8ec62f3e91",
      "id": "51e8ed1be2129b000200000a",
      "s3_object_key": "a54f0a9c-1dfc-c689-045d-e54f7e645872",
      "shot_at": "2013-03-30T08:54:05Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:09Z",
      "fingerprint": "49171d37d52d672d71f095e20b80b999",
      "id": "51e8ed1db09ddc0002000010",
      "s3_object_key": "d8fb8ca6-3b46-d763-9dbf-fd8388402d1d",
      "shot_at": "2013-03-30T08:25:14Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 1.5047879616963065,
      "created_at": "2013-07-19T07:39:11Z",
      "fingerprint": "0ffdd4e7ff8a7d4d51b3c3b0ba1bb672",
      "id": "51e8ed1fe2129b000200000c",
      "s3_object_key": "0161d247-b64e-16f5-b4f9-27c33ad6451c",
      "shot_at": "2013-03-30T08:02:53Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 1.5049157303370786,
      "created_at": "2013-07-19T07:39:13Z",
      "fingerprint": "ab96fa1ba348d58082a465777630b684",
      "id": "51e8ed21b09ddc0002000014",
      "s3_object_key": "cc10fccc-7cf9-04c3-1794-d8ba489d1119",
      "shot_at": "2013-03-30T08:04:16Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:14Z",
      "fingerprint": "a90d370e91e3619200923d4337a85872",
      "id": "51e8ed22e2129b000200000e",
      "s3_object_key": "3c1618ba-bddb-a51e-4fed-86c549eeb539",
      "shot_at": "2013-03-29T16:20:06Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 1.5047879616963065,
      "created_at": "2013-07-19T07:39:14Z",
      "fingerprint": "7a4ade82b715e8651468d12c3bf2a4cc",
      "id": "51e8ed22e2129b0002000010",
      "s3_object_key": "1192ce85-5675-46f0-ddfc-6c49b5ccbb44",
      "shot_at": "2013-03-29T16:05:44Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 1.5047879616963065,
      "created_at": "2013-07-19T07:39:16Z",
      "fingerprint": "da62b89db0c8dd6d7865373ae3610bd7",
      "id": "51e8ed24b09ddc0002000016",
      "s3_object_key": "cb744883-f13a-bf5b-ab9d-5edeafadccc7",
      "shot_at": "2013-03-30T08:25:11Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 1.5047879616963065,
      "created_at": "2013-07-19T07:39:16Z",
      "fingerprint": "8ded6a7e8e98528554e6733c6ad4a721",
      "id": "51e8ed24e2129b0002000012",
      "s3_object_key": "fc5fdcc8-64f1-de56-74bc-e0518edeae5f",
      "shot_at": "2013-03-30T08:04:11Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 1.5047879616963065,
      "created_at": "2013-07-19T07:39:18Z",
      "fingerprint": "555fee68514ddd00c51295ed9a1e9d12",
      "id": "51e8ed26b09ddc0002000018",
      "s3_object_key": "f2044ecb-671b-1cd3-10ca-ff84ff42936e",
      "shot_at": "2013-03-30T08:59:23Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:19Z",
      "fingerprint": "87ddd9061a4818b30714e75d88b93177",
      "id": "51e8ed27e2129b0002000014",
      "s3_object_key": "618e41ea-4fcc-90d4-4295-f8ee4d87006e",
      "shot_at": "2013-03-30T09:05:30Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 1.5047879616963065,
      "created_at": "2013-07-19T07:39:19Z",
      "fingerprint": "8864a6f716f5ebb9b196d1293115bc59",
      "id": "51e8ed27b09ddc000200001a",
      "s3_object_key": "20b47a31-1ded-ec7d-a08d-7cd605189536",
      "shot_at": "2013-03-30T08:44:16Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }, {
      "aspect_ratio": 0.6645454545454546,
      "created_at": "2013-07-19T07:39:21Z",
      "fingerprint": "4d35ed6ba2218d7a86d2edb2ec46c0f5",
      "id": "51e8ed29e2129b0002000016",
      "s3_object_key": "f30bed2b-1888-6f88-20c4-d3870a2a9d62",
      "shot_at": "2013-03-30T08:25:42Z",
      "updated_at": "2013-07-19T07:39:31Z"
    }
]);

// Ideal photo distribution
// Retrieved on 2013-08-13 from http://www.crispymtn.com/stories/the-algorithm-for-a-perfectly-balanced-photo-gallery
var ideal_height, index, partition, row_buffer, rows, summed_width, viewport_width, weights;

viewport_width = $(window).width();

ideal_height = parseInt($(window).height() / 2, 10);

summed_width = photos.reduce((function(sum, p) {
  return sum += p.get('aspect_ratio') * ideal_height;
}), 0);

rows = Math.round(summed_width / viewport_width);

if (rows < 1) {
  // (2a) Fallback to just standard size
  photos.each(function(photo) {
    return photo.set('size', [parseInt(ideal_height * photo.get('aspect_ratio'), 10), ideal_height]);
  });
} else {
  // (2b) Distribute photos over rows using the aspect ratio as weight
  weights = photos.map(function(p) {
    return parseInt(p.get('aspect_ratio') * 100, 10);
  });
  partition = linear_partition(weights, rows);

  // (3) Iterate through partition
  index = 0;
  row_buffer = new Backbone.Collection();
  _.each(partition, function(row) {
    var summed_ratios;
    row_buffer.reset();
    _.each(row, function() {
      return row_buffer.add(photos.at(index++));
    });
    summed_ratios = row_buffer.reduce((function(sum, p) {
      return sum += p.get('aspect_ratio');
    }), 0);
    return row_buffer.each(function(photo) {
      return photo.set('size', [parseInt(viewport_width / summed_ratios * photo.get('aspect_ratio'), 10), parseInt(viewport_width / summed_ratios, 10)]);
    });
  });
console.log(row_buffer);

}
